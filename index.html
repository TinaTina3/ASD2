<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Quiz autonome avec config.js</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>哪個表情不一樣?</h1>

    <form id="quizForm">
        <div>
            <label for="姓名">Nom&nbsp;:</label>
            <input type="text" id="name" name="name" autocomplete="family-name" required />
        </div>
        <div>
            <label for="電子信箱">Email&nbsp;:</label>
            <input type="text" id="email" name="email" autocomplete="email" required />
        </div>

        <div id="questionsContainer"></div>

        <button type="submit" id="submitBtn" disabled>查看我的成績</button>
    </form>

    <div id="resultContainer" style="display:none; max-width:800px; margin:auto; padding:20px;"></div>

    <script src="config.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("quizForm");
            const submitBtn = document.getElementById("submitBtn");
            const resultDiv = document.getElementById("resultContainer");
            const container = document.getElementById("questionsContainer");
            const questions = window.cfg?.questions;
            const feedbacks = window.cfg?.feedbacks;

            if (!questions) {
                container.innerHTML = "<p>Impossible de charger la configuration.</p>";
                return;
            }

            questions.forEach((q, qi) => {
                const bloc = document.createElement("div");
                bloc.className = "question";
                bloc.dataset.index = qi;
                if (qi === 0) bloc.classList.add("active");

                const h2 = document.createElement("h2");
                h2.textContent = q.title;
                bloc.appendChild(h2);

                const optsDiv = document.createElement("div");
                optsDiv.className = "options";

                const feedback = document.createElement("textarea");
                feedback.name = "feedback" + qi;
                feedback.id = "feedback" + qi;
                feedback.readOnly = true;

                q.options.forEach((opt, oi) => {
                    const label = document.createElement("label");
                    label.className = "option";

                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = "q" + qi;
                    radio.value = oi;

                    const img = document.createElement("img");
                    img.src = opt.image;
                    img.alt = `${q.title} – option ${oi + 1}`;

                    label.appendChild(radio);
                    label.appendChild(img);

                    img.addEventListener("click", () => {
                        radio.checked = true;
                        feedback.value = q.comment;

                        feedback.classList.add("visible");

                        optsDiv.querySelectorAll("label").forEach(lbl => {
                            lbl.classList.remove("correct", "incorrect");
                        });

                        if (opt.value === true) {
                            label.classList.add("correct");
                        } else {
                            label.classList.add("incorrect");
                        }

                        optsDiv.querySelectorAll("img").forEach(img2 => {
                            img2.style.pointerEvents = "none";
                            if (img2 !== img) img2.style.opacity = "0.5";
                        });

                        const next = document.querySelector(`.question[data-index="${qi + 1}"]`);
                        if (next) setTimeout(() => next.classList.add("active"), 400);

                        setTimeout(checkFormCompletion, 100);
                    });

                    optsDiv.appendChild(label);
                });

                bloc.appendChild(optsDiv);
                bloc.appendChild(feedback);
                container.appendChild(bloc);
            });

            function checkFormCompletion() {
                const nameFilled = form.querySelector('[name="name"]').value.trim() !== "";
                const emailFilled = form.querySelector('[name="email"]').value.trim() !== "";

                const allAnswered = questions.every((_, qi) =>
                    form.querySelector(`input[name="q${qi}"]:checked`)
                );

                const isComplete = nameFilled && emailFilled && allAnswered;
                submitBtn.disabled = !isComplete;
                submitBtn.classList.toggle("active", isComplete);
            }

            form.name.addEventListener("input", checkFormCompletion);
            form.email.addEventListener("input", checkFormCompletion);

            form.addEventListener("submit", e => {
                e.preventDefault();
                const data = new FormData(form);
                const user = {
                    nom: data.get("name"),
                    email: data.get("email")
                };

                let bonnesReponses = 0;
                let html = `<h2>你的回答 ${user.nom}</h2><ul>`;

                questions.forEach((q, qi) => {
                    const choixIdx = data.get("q" + qi);
                    if (choixIdx === null) {
                        html += `<li>${q.title} : sans réponse</li>`;
                    } else {
                        const opt = q.options[parseInt(choixIdx)];
                        if (opt.value === true) bonnesReponses++;
                        const isGood = opt.value === true;
                        html += `
      <div class="response-item ${isGood ? 'correct' : 'incorrect'} flip-in">
        <h4>${q.title}</h4>
        <img src="${opt.image}" alt="選擇照片" class="selected-image" />
        <p><strong>Commentaire :</strong> ${q.comment}</p>
      </div>
`;

                    }
                });

                const totalQuestions = questions.length;
                const percentage = Math.round((bonnesReponses / totalQuestions) * 100);
                const feedback = feedbacks.find(f => percentage >= f.min && percentage <= f.max);
                const finalComment = feedback?.comment || "Pas de feedback disponible.";
                const feedbackClass = percentage >= 50 ? 'success' : 'error';
                html += `
      <div class="score-summary ${feedbackClass} flip-in">
        <h2>總成績</h2>
        <p><strong>正確回答題數 :</strong> ${bonnesReponses} / ${totalQuestions}</p>
        <p><strong>得分 :</strong> ${percentage}%</p>
        <p class="final-feedback">${finalComment}</p>
      </div>
`;

                form.style.display = "none";
                resultDiv.innerHTML = html;
                resultDiv.style.display = "block";
            });
        });
    </script>
</body>
</html>
